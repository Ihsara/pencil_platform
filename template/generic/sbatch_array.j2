#!/bin/bash
#SBATCH --job-name={{ sbatch.job_name }}
#SBATCH --account={{ sbatch.account }}
#SBATCH --partition={{ sbatch.partition }}
#SBATCH --time={{ sbatch.time }}
#SBATCH --nodes={{ sbatch.nodes }}
#SBATCH --ntasks={{ sbatch.ntasks }}
#SBATCH --cpus-per-task={{ sbatch.cpus_per_task }}
#SBATCH --array=1-{{ num_jobs }}
#SBATCH --output={{ run_base_dir }}/slurm_logs/output_%A_%a.txt
#SBATCH --error={{ run_base_dir }}/slurm_logs/errors_%A_%a.txt
{% if sbatch.mail_user %}
#SBATCH --mail-user={{ sbatch.mail_user }}
#SBATCH --mail-type={{ sbatch.mail_type | default('FAIL') }}
{% endif %}

set -e

# --- Use SLURM's environment variable for the submission directory ---
# This is the most robust way to find our accompanying files.
MANIFEST_FILE="${SLURM_SUBMIT_DIR}/{{ manifest_file }}"

# Get the name of the specific run directory for this task from the manifest
RUN_NAME=$(sed -n "${SLURM_ARRAY_TASK_ID}p" "$MANIFEST_FILE")
if [ -z "$RUN_NAME" ]; then
    echo "ERROR: Could not read RUN_NAME from manifest for task ID ${SLURM_ARRAY_TASK_ID}" >&2
    exit 1
fi

# --- Define Paths ---
SOURCE_BASE_DIR="{{ hpc.source_base_dir }}"
RUN_BASE_DIR="{{ run_base_dir }}"
RUN_DIR="${RUN_BASE_DIR}/${RUN_NAME}"
LOGFILE="${RUN_DIR}/simulation.log"

# This is the directory where the python script saved our generated configs
LOCAL_GENERATED_CONFIG_DIR="${SLURM_SUBMIT_DIR}/generated_configs/${RUN_NAME}"

echo "INFO: Starting SLURM task ${SLURM_ARRAY_TASK_ID} for run: ${RUN_NAME}"

# --- Setup the Run Directory using pc_newrun ---
echo "INFO: Setting up run directory from ${SOURCE_BASE_DIR} to ${RUN_DIR}"
pc_newrun -s "${SOURCE_BASE_DIR}" "${RUN_DIR}"

# --- CRUCIAL FIX: Copy the unique generated config files into the new run directory ---
echo "INFO: Copying generated config files from ${LOCAL_GENERATED_CONFIG_DIR}"
cp -v "${LOCAL_GENERATED_CONFIG_DIR}"/* "${RUN_DIR}/"

# --- Navigate and Execute ---
echo "INFO: Changing to working directory: ${RUN_DIR}"
cd "$RUN_DIR" || exit 1

echo "INFO: Starting simulation run..." > $LOGFILE

# (The rest of the script for running start.csh/run.csh is unchanged)
# ...